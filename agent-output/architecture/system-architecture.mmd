%% System Architecture Diagram (Mermaid)
%% Last Updated: 2026-01-27

flowchart TB
    %% Added quotes around the text inside [] to handle parentheses safely
    Client["External_Clients\n(Web/Mobile/CLI)"]:::external

    subgraph Infra[Shared Infrastructure]
      Kafka[(Kafka)]:::infra
      SR[(Schema Registry)]:::infra
      Obj[("Object Store (Optional)\nMinIO/S3")]:::infra
    end

    %% Added quotes here
    Contract["Shared Contract Artifact\n(Avro .avsc + envelope\n+ optional generated bindings)"]:::shared

    %% Services
    subgraph Services[Independent Microservices]
      %% Added quotes to all these descriptions containing ()
      GW["Ingress Gateway\n(WebSocket Phase 1 / gRPC Phase 2)"]:::svc
      VAD["VAD Service\n(silence removal)"]:::svc
      ASR["ASR Service\n(audio → text)"]:::svc
      TR["Translation Service\n(text → translated text)"]:::svc
      TTS["TTS Service\n(Kokoro-82M ONNX)\n(text → audio)"]:::svc
    end

    %% Topics (logical)
    Client -->|WebSocket/gRPC| GW
    GW -->|"speech.audio.ingress\nAudioInputEvent (Avro)"| Kafka
    Kafka -->|"speech.audio.ingress\nAudioInputEvent"| VAD
    VAD -->|"speech.audio.speech_segment\nSpeechSegmentEvent"| Kafka
    Kafka -->|"speech.audio.speech_segment\nSpeechSegmentEvent"| ASR
    ASR -->|"speech.asr.text\nTextRecognizedEvent"| Kafka
    Kafka -->|"speech.asr.text\nTextRecognizedEvent"| TR
    TR -->|"speech.translation.text\nTextTranslatedEvent"| Kafka
    Kafka -->|"speech.translation.text\nTextTranslatedEvent"| TTS
    TTS -->|"speech.tts.audio\nAudioSynthesisEvent"| Kafka
    Kafka -->|"speech.tts.audio\nAudioSynthesisEvent"| Client

    %% Optional artifact persistence + large-payload path (URIs carried in events)
    %% Speaker context may be carried inline (speaker_id / speaker_reference_bytes) or as a URI when needed.
    GW -. "audio_uri (optional)" .-> Obj
    VAD -. "segment_uri (optional)" .-> Obj
    TTS -. "audio_uri (optional)" .-> Obj

    %% Registry usage
    ASR --- SR
    TR --- SR
    GW --- SR
    VAD --- SR
    TTS --- SR
    Client --- SR

    %% Contract usage
    Contract --- ASR
    Contract --- TR
    Contract --- GW
    Contract --- VAD
    Contract --- TTS
    Contract --- Client

    classDef infra fill:#e3f2fd,stroke:#1565c0,color:#0d47a1;
    classDef svc fill:#e8f5e9,stroke:#2e7d32,color:#1b5e20;
    classDef shared fill:#fff3e0,stroke:#ef6c00,color:#e65100;
    classDef external fill:#eeeeee,stroke:#616161,color:#212121;