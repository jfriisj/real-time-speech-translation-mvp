services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    container_name: speech-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - speech_net

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    container_name: speech-kafka
    depends_on:
      - zookeeper
    ports:
      - "127.0.0.1:29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://127.0.0.1:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_MESSAGE_MAX_BYTES: 2097152
      KAFKA_REPLICA_FETCH_MAX_BYTES: 2097152
    networks:
      - speech_net

  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.3
    container_name: speech-schema-registry
    depends_on:
      - kafka
    ports:
      - "127.0.0.1:8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://kafka:9092
      SCHEMA_REGISTRY_COMPATIBILITY_LEVEL: BACKWARD
    healthcheck:
      test:
        ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/localhost/8081 && printf \"GET /subjects HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n\" >&3 && head -n 1 <&3 | grep -q \"200\"'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - speech_net

  minio:
    image: ${MINIO_IMAGE_REF:-minio/minio@sha256:14cea493d9a34af32f524e538b8346cf79f3321eff8e708c1e2960462bd8936e}
    container_name: speech-minio
    command: server /data --console-address ":9001"
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    networks:
      - speech_net

  minio-init:
    image: ${MINIO_MC_IMAGE_REF:-minio/mc@sha256:a7fe349ef4bd8521fb8497f55c6042871b2ae640607cf99d9bede5e9bdf11727}
    container_name: speech-minio-init
    depends_on:
      - minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    entrypoint: >
      /bin/sh -c "
      for i in $(seq 1 20); do
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin} && break;
        echo 'waiting for minio...';
        sleep 2;
      done &&
      for bucket in audio-ingress vad-segments asr-transcripts tts-audio; do
        mc mb -p local/$bucket || true;
        mc ilm import local/$bucket < /lifecycle.json;
      done
      "
    volumes:
      - ./minio-lifecycle.json:/lifecycle.json:ro
    networks:
      - speech_net

  asr-service:
    build:
      context: .
      dockerfile: services/asr/Dockerfile
    container_name: speech-asr-service
    depends_on:
      schema-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      MODEL_NAME: openai/whisper-tiny
      SCHEMA_DIR: /app/shared/schemas/avro
      ASR_INPUT_TOPIC: speech.audio.ingress
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: audio-ingress
      MINIO_SECURE: "0"
    volumes:
      - hf_cache:/app/.cache/huggingface
    networks:
      - speech_net

  vad-service:
    build:
      context: .
      dockerfile: services/vad/Dockerfile
    container_name: speech-vad-service
    depends_on:
      schema-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      SCHEMA_DIR: /app/shared/schemas/avro
      TARGET_SAMPLE_RATE_HZ: 16000
      VAD_WINDOW_MS: 30
      VAD_HOP_MS: 10
      VAD_SPEECH_THRESHOLD: 0.5
      VAD_ENERGY_THRESHOLD: 0.01
      VAD_MIN_SPEECH_MS: 250
      VAD_MIN_SILENCE_MS: 200
      VAD_PADDING_MS: 100
      VAD_USE_ONNX: "1"
      VAD_MODEL_REPO: onnx-community/silero-vad
      VAD_MODEL_FILENAME: silero_vad.onnx
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: vad-segments
      MINIO_SECURE: "0"
    volumes:
      - hf_cache:/app/.cache/huggingface
    networks:
      - speech_net

  translation-service:
    build:
      context: .
      dockerfile: services/translation/Dockerfile
    container_name: speech-translation-service
    depends_on:
      schema-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      TARGET_LANGUAGE: es
      SCHEMA_DIR: /app/shared/schemas/avro
      HF_HOME: /app/.cache/huggingface
    volumes:
      - hf_cache:/app/.cache/huggingface
    networks:
      - speech_net

  tts-service:
    build:
      context: .
      dockerfile: services/tts/Dockerfile
    container_name: speech-tts-service
    depends_on:
      schema-registry:
        condition: service_healthy
      kafka:
        condition: service_started
      minio:
        condition: service_started
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      SCHEMA_DIR: /app/shared/schemas/avro
      TTS_MODEL_NAME: kokoro-82m-onnx
      TTS_MODEL_CACHE_DIR: /app/model_cache
      TTS_MODEL_REVISION: ${TTS_MODEL_REVISION:-1939ad2a8e416c0acfeecc08a694d14ef25f2231}
      HF_TOKEN: ${HF_TOKEN:-}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: tts-audio
      MINIO_SECURE: "0"
      INLINE_PAYLOAD_MAX_BYTES: ${INLINE_PAYLOAD_MAX_BYTES:-1310720}
      TTS_AUDIO_URI_MODE: ${TTS_AUDIO_URI_MODE:-internal}
    volumes:
      - ./model_cache:/app/model_cache
    networks:
      - speech_net

  gateway-service:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: speech-gateway-service
    depends_on:
      schema-registry:
        condition: service_healthy
      kafka:
        condition: service_started
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      SCHEMA_REGISTRY_URL: http://schema-registry:8081
      SCHEMA_DIR: /app/shared/schemas/avro
      GATEWAY_HOST: 0.0.0.0
      GATEWAY_PORT: 8000
      SAMPLE_RATE_HZ: 16000
      AUDIO_FORMAT: wav
      MAX_BUFFER_BYTES: 5242880
      MAX_CHUNK_BYTES: 65536
      MAX_CONNECTIONS: 10
      IDLE_TIMEOUT_SECONDS: 10
      MAX_SESSION_SECONDS: 60
      MAX_MESSAGES_PER_SECOND: 200
      ORIGIN_ALLOWLIST: ""
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
      MINIO_BUCKET: audio-ingress
      MINIO_SECURE: "0"
    user: "1000:1000"
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    mem_limit: "512m"
    cpus: "0.5"
    networks:
      - speech_net

networks:
  speech_net:
    driver: bridge

volumes:
  hf_cache:
